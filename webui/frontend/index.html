<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Binance Bot UI</title>
    <style>
  /* Allow wider layout so dashboard can use left area and side buttons on the right */
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:1280px;margin:12px auto;padding:0 12px;background:#fff;min-height:100vh;overflow:auto}
  .card{border:1px solid #eee;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 3px 12px rgba(10,12,14,.05);background:#fff}

  /* Login form tweaks */
  #login_form{width:380px;box-shadow:0 10px 30px rgba(10,12,14,0.06);padding:26px;border-radius:12px}
  #login_form input{width:100%;margin-bottom:10px;padding:10px 12px;border-radius:10px;border:1px solid #e3e3e3;font-size:14px}
  #login_btn{width:100%;padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(180deg,#3b82f6,#2563eb);color:#fff;font-weight:600;box-shadow:0 8px 20px rgba(37,99,235,0.12)}

  /* Base button style */
  button{padding:8px 12px;border-radius:8px;border:1px solid #d1d1d1;background:linear-gradient(#ffffff,#f2f2f2);box-shadow:0 3px 0 rgba(0,0,0,0.03);cursor:pointer;font-family:inherit;color:#222;transition:all .12s ease-in-out}
  button:hover{ transform:translateY(-2px); box-shadow:0 10px 26px rgba(15,20,25,0.06); }

  /* Side column buttons slightly larger and left-aligned text */
  #side_btns button{background: linear-gradient(#f9f9f9,#f3f3f3);border-radius:10px;padding:10px 14px;text-align:left;box-shadow: 0 2px 6px rgba(0,0,0,0.04);font-size:14px;width:220px}

  /* Start/Stop small primary style - grouped on top-left */
  .top-controls{display:flex;gap:8px;align-items:center}
  #start, #stop{ padding:6px 10px; font-size:13px;border-radius:8px }

  /* Logout highlight */
  #logout_btn, #logout_btn_side{ background: linear-gradient(#fdecea,#f7d7d7); border-color:#e8bfbf; }

  .row{display:flex;gap:12px;align-items:center}
  h1.page-title{font-size:28px;text-align:center;margin:6px 0 4px 0;letter-spacing:0.5px}
  .sub-title{font-size:12px;color:#666;text-align:center;margin-bottom:16px}
  code{background:#f6f8fa;padding:2px 6px;border-radius:6px}

  /* Dashboard layout rules */
  .dashboard-container{display:flex;align-items:flex-start;gap:20px;position:relative}
  /* Keep main card responsive but leave space for the fixed right-side controls (220px + gap)
    This prevents the terminal from flowing underneath the side buttons on narrower viewports. */
  #main_card{flex:1;min-width:320px;max-width:calc(100% - 260px)}

  /* Terminal style: keep terminal compact and prevent it from expanding vertically.
     Show single-line log entries without wrapping; allow horizontal + vertical scrolling. */
  #terminal{
    font-family:'Fira Mono','Consolas','Menlo','Monospace';
    font-size:13px;
    background:#1f2937;
    color:#e6eef8;
    padding:12px;
    border-radius:12px;
    height:220px;           /* preferred visible height */
    max-height:260px;       /* limit vertical growth */
    min-height:120px;
    min-width:0;
    width:100%;
  overflow-x:auto;        /* allow horizontal scroll when needed */
  overflow-y:auto;        /* vertical scroll if content exceeds max-height */
  white-space:pre-wrap;   /* wrap long lines to avoid horizontal expansion */
  overflow-wrap:break-word;
  word-break:break-word;
    box-shadow:inset 0 -6px 18px rgba(0,0,0,0.12);
    box-sizing:border-box;
    scrollbar-gutter:stable;
    border:1.5px solid #d1d5db;
    max-width:100%;
  }

  /* Remove the thin red divider (hidden) — handled visually by spacing now */
  .divider{display:none}

  /* Make the side buttons column fixed on the right for a floating control panel */
  #side_btns{position:fixed;right:18px;top:120px;display:flex;flex-direction:column;gap:12px;z-index:30}

  /* responsive tweaks */
  @media(max-width:900px){ #side_btns{position:static;width:100%;flex-direction:row;overflow:auto} #main_card{min-width:0} }
  /* Keep a safe right margin for the terminal when the side button column is fixed on
     wide viewports so logs don't visually flow under the side controls. */
  @media(min-width:901px) {
    #terminal { margin-right: 260px; }
  }
    </style>
  </head>
  <body>
  <script>
    // Minimal global helper so early inline scripts can use $('id') safely.
    function $(id) {
      if (!id) return null;
      if (typeof id === 'string' && id.startsWith('.')) return document.querySelector(id);
      return document.getElementById(id);
    }
  </script>
  <div id="login_section" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:90vh;">
      <form id="login_form" style="width:370px;" autocomplete="off" onsubmit="return false;">
  <div style="font-size:2em;font-weight:bold;text-align:center;margin-bottom:0;white-space:nowrap;display:flex;justify-content:center;">Binance Auto Trading Bot</div>
  <div style="font-size:1em;color:#555;margin-bottom:30px;text-align:center;display:flex;justify-content:center;">(ATS Pro ensures your success in trading)</div>
        <div style="font-weight:bold;text-align:center;margin-bottom:8px;font-size:1.1em;">Login</div>
        <input id="login_email" type="email" placeholder="Email" style="width:100%;margin-bottom:7px;padding:4px;" autocomplete="username" required />
        <input id="login_password" type="password" placeholder="Password" style="width:100%;margin-bottom:7px;padding:4px;" autocomplete="current-password" required />
  <button id="login_btn" type="submit" style="width:60%;margin:0 auto 7px auto;padding:7px 0 7px 0;background:#2563eb;border:1px solid #1e40af;border-radius:7px;color:#fff;font-weight:600;font-size:1.08em;display:block;letter-spacing:0.5px;">Login</button>
        <div id="login_msg" style="color:red;margin-top:8px;text-align:center;"></div>
        <div style="margin-top:60px;font-size:15px;text-align:center;color:#222;">
          © 2025-2030, The Auto Trade Solutions (ATS Pro)
        </div>
      </form>
    </div>
  <!-- Dashboard layout: left main card + right side buttons -->
  <div class="dashboard-container" style="display:none;align-items:flex-start;gap:20px;">
  <div id="main_card" class="card" style="flex-direction:column;gap:10px;flex:1;">
      <!-- Top info row: left=start/stop+summary, center=balances, right=netmode + logged in -->
      <div class="card" style="padding:12px;display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px;">
        <div style="flex:1;min-width:220px;">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
            <button id="start" style="margin-right:6px;padding:6px 10px">Start Bot</button>
            <button id="stop" style="padding:6px 10px">Stop Bot</button>
            <div style="margin-left:10px;font-weight:600;">Status: <span id="status">...</span></div>
          </div>
          <div>
            <b>Summary:</b><br>
              Total Win: <span id="win">...</span> &nbsp; Total Loss: <span id="loss">...</span> &nbsp; PnL: <span id="pnl">...</span>
            <!-- Last status payload removed per user request -->
          </div>
        </div>
        <div style="flex:0 0 280px;text-align:center;">
          <b>Available Balance:</b><br>
          USDT: <span id="bal_usdt">...</span><br>
          BTC: <span id="bal_btc">...</span>
        </div>
        <div style="flex:0 0 220px;text-align:right;">
          <div style="margin-bottom:8px;font-weight:600;">Net Mode:</div>
          <div style="text-align:right;">
            <label><input type="radio" name="netmode" value="testnet" checked id="netmode_testnet"> Testnet</label><br>
            <label><input type="radio" name="netmode" value="mainnet" id="netmode_mainnet"> Mainnet</label>
          </div>
          <div style="margin-top:8px;text-align:right;color:#444;">Logged in as: <span id="logged_in_as">...</span></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div style="flex:1;">
          <b>Terminal Output:</b>
          <div class="divider" aria-hidden="true"></div>
          <div id="terminal"></div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div>Pending Trades: <span id="pending">...</span> &nbsp; Pending Amount (in USDT): <span id="pending_amt">...</span></div>
      </div>
    </div>
    <!-- Right-side action buttons column -->
  <div id="side_btns" style="display:flex;flex-direction:column;gap:10px;z-index:20;width:220px;align-self:flex-start;">
  <button id="config_btn" style="padding:8px 10px;font-size:13px;text-align:left;font-weight:bold;background:#e0f7fa;">Configuration</button>
  <button id="signal_btn" style="padding:8px 10px;font-size:13px;text-align:left;">Signal Debug</button>
  <button id="retrain_btn" style="padding:8px 10px;font-size:13px;text-align:left;">Bot Re-Train</button>
  <button id="profit_report_btn" style="padding:8px 10px;font-size:13px;text-align:left;">Download Profit Report (CSV)</button>
  <button id="equity_plot_btn" style="padding:8px 10px;font-size:13px;text-align:left;">Show Equity Curve</button>
  <button id="trade_history_btn" style="padding:8px 10px;font-size:13px;text-align:left;">Trade History Report</button>
  <button id="pending_trades_btn" style="padding:8px 10px;font-size:13px;text-align:left;">Pending Trades Report</button>
  <button id="reconcile_btn" style="padding:8px 10px;font-size:13px;text-align:left;background:#fff7ed;">Bot Reconciliation</button>
  <button id="force_sell_btn" style="padding:8px 10px;font-size:13px;text-align:left;background:#ffe0e0;color:#c00;font-weight:bold;">Force SELL</button>
    <!-- Other side buttons ... -->
  <button id="change_pw_btn_side" style="padding:8px 10px;font-size:13px;text-align:left;border-radius:8px">Change Password</button>
  <button id="logout_btn_side" style="padding:8px 10px;font-size:13px;background:#f3d6d6;text-align:left;border-radius:8px">Logout</button>
  <!-- Modal for reports -->

</div>

<!-- Move Force SELL button handler to script block -->
<script>
  // Helper for element selection
  // NOTE: a more flexible `$` helper is defined later in the file; avoid
  // declaring it twice to prevent "Identifier '$' has already been declared".
  // Force SELL button handler
  if ($('force_sell_btn')) $('force_sell_btn').onclick = async () => {
    if ($('terminal')) $('terminal').textContent = 'Force SELL: processing...';
    try {
      const r = await fetch('/api/force_sell', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      const j = await r.json();
      if (j.ok) {
        $('terminal').textContent = 'Force SELL completed: ' + (j.closed || 0) + ' trades closed.';
        if (typeof pollStatus === 'function') pollStatus();
      } else {
        $('terminal').textContent = 'Force SELL failed: ' + (j.error || 'Unknown error');
      }
    } catch (e) {
      $('terminal').textContent = 'Force SELL call failed';
    }
  };
</script>
  <div id="report_modal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:18px 12px 12px 12px;border-radius:13px;min-width:260px;max-width:90vw;width:900px;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;max-height:96vh;overflow-y:auto;font-size:13px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <h2 id="report_modal_title" style="margin-top:0;margin-bottom:12px;font-size:1.1em;">Report</h2>
        <button id="report_modal_csv" style="margin-bottom:0;display:none;">Download CSV</button>
      </div>
      <div id="report_modal_summary" style="margin-bottom:8px;font-size:14px;color:#2563eb;font-weight:500;"></div>
      <div id="report_modal_table" style="overflow-x:auto;"></div>
      <button id="report_modal_close" style="position:absolute;top:-10px;right:-10px;font-size:1.3em;background:#fff;border-radius:50%;border:1px solid #eee;color:#888;box-shadow:0 2px 8px #0001;z-index:10;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">&times;</button>
    </div>
  </div>
  <!-- Reconcile Confirmation Modal -->
  <div id="confirm_reconcile_modal" style="display:none;position:fixed;z-index:2100;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:18px;border-radius:12px;min-width:260px;max-width:90vw;width:420px;box-shadow:0 8px 32px rgba(0,0,0,0.18);">
      <h3 style="margin-top:0;margin-bottom:8px;">Confirm Reconcile</h3>
      <div style="margin-bottom:12px;color:#333;">This will reconcile pending trades with the exchange. Are you sure you want to continue?</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;"><button id="confirm_reconcile_cancel">Cancel</button><button id="confirm_reconcile_yes" style="background:#2563eb;color:#fff;border-color:#1e40af;">Yes, run reconcile</button></div>
    </div>
  </div>
  <script>
  // --- Report Modal Logic ---
  let lastReportRows = [];
  let lastReportColumns = [];
  function showReportModal(title, html, rows, columns) {
    const modal = document.getElementById('report_modal');
    document.getElementById('report_modal_title').textContent = title;
    document.getElementById('report_modal_table').innerHTML = html;
    lastReportRows = rows || [];
    lastReportColumns = columns || [];
    // Show CSV button only if there is data
    const csvBtn = document.getElementById('report_modal_csv');
    if (lastReportRows.length > 0 && lastReportColumns.length > 0) {
      csvBtn.style.display = 'inline-block';
    } else {
      csvBtn.style.display = 'none';
    }
    // Summary handled in fetchAndShowReport
    modal.style.display = 'flex';
  }
  function hideReportModal() {
    document.getElementById('report_modal').style.display = 'none';
  }

  function downloadCSVFromRows(rows, columns, filename) {
    let csv = '';
    csv += columns.map(c => '"'+c.replace(/"/g,'""')+'"').join(',') + '\r\n';
    for (const row of rows) {
      csv += columns.map(c => '"'+((row[c]!==undefined && row[c]!==null)?String(row[c]).replace(/"/g,'""'):'')+'"').join(',') + '\r\n';
    }
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);}, 200);
  }
  document.getElementById('report_modal_csv').onclick = function() {
    const title = document.getElementById('report_modal_title').textContent || 'report';
    downloadCSVFromRows(lastReportRows, lastReportColumns, title.replace(/\s+/g,'_').toLowerCase()+'.csv');
  };
  document.getElementById('report_modal_close').onclick = hideReportModal;

  async function fetchAndShowReport(url, title, columns) {
    try {
      const res = await fetch(url);
      const j = await res.json();
      let rows = (j.trades || j.pendings || []);
      if (!Array.isArray(rows)) rows = [];
      window.lastReportApiResult = j; // set after rows extraction
      console.log('[DEBUG] fetchAndShowReport', url, 'rows:', rows, 'pending_qty:', j.pending_qty);
      let html = '<table style="border-collapse:collapse;width:100%">';
      html += '<tr>' + columns.map(c => `<th style=\"border:1px solid #ccc;padding:4px 6px;background:#f3f3f3;\">${c}</th>`).join('') + '</tr>';
      for (const row of rows) {
        html += '<tr>' + columns.map(c => `<td style=\"border:1px solid #eee;padding:4px 6px;\">${row[c]!==undefined?row[c]:''}</td>`).join('') + '</tr>';
      }
      html += '</table>';
      // --- summary line update ---
      const summaryDiv = document.getElementById('report_modal_summary');
      if (title.toLowerCase().includes('pending trades')) {
        let pendingQty = (typeof j.pending_qty === 'number') ? j.pending_qty : rows.reduce((sum, r) => sum + (parseFloat(r.qty)||0), 0);
        let totalAmt = rows.reduce((sum, r) => sum + (parseFloat(r.amount_usdt)||0), 0);
        summaryDiv.innerHTML = `Pending Qty: <b>${pendingQty.toFixed(6)}</b> | Pending Amount (USDT): <b>${totalAmt.toFixed(2)}</b>`;
      } else {
        summaryDiv.innerHTML = '';
      }
      showReportModal(title, html, rows, columns);
    } catch(e) {
      showReportModal(title, '<div style="color:#c00">Failed to load report.</div>', [], []);
    }
  }
  document.getElementById('trade_history_btn').onclick = function() {
    fetchAndShowReport('/api/trade_history', 'Trade History Report', ['orderId','side','qty','entry','close_price','realized_pnl_usdt','status','timestamp']);
  };
  document.getElementById('pending_trades_btn').onclick = function() {
    fetchAndShowReport('/api/pending_trades', 'Pending Trades Report', ['orderId','side','qty','amount_usdt','entry','status','timestamp']);
  };
  // Show confirm modal before running reconcile
  const reconcileBtn = document.getElementById('reconcile_btn');
  if(reconcileBtn){
    reconcileBtn.addEventListener('click', function(){
      const modal = document.getElementById('confirm_reconcile_modal');
      if(modal) modal.style.display = 'flex';
    });
  }
  // Modal buttons
  if(document.getElementById('confirm_reconcile_cancel')){
    document.getElementById('confirm_reconcile_cancel').onclick = function(){ document.getElementById('confirm_reconcile_modal').style.display = 'none'; if($('terminal')) $('terminal').textContent = 'Reconcile cancelled'; };
  }
  if(document.getElementById('confirm_reconcile_yes')){
    document.getElementById('confirm_reconcile_yes').onclick = async function(){
      document.getElementById('confirm_reconcile_modal').style.display = 'none';
      if($('terminal')) $('terminal').textContent = 'Running reconciliation...';
      try{
        const headers = {'Content-Type':'application/json'};
        const body = {timeout:20};
        let r = await fetch('/api/reconcile',{method:'POST', headers: headers, body: JSON.stringify(body), credentials: 'same-origin'});
        if(r.status === 401){
          // Not authorized with session: fallback to token prompt (for setups using RECONCILE_TOKEN)
          sessionStorage.removeItem('reconcile_token');
          let token = null;
          try{ token = prompt('Enter reconcile token (leave blank to cancel):'); }catch(e){ token = null; }
          if(!token){ if($('terminal')) $('terminal').textContent = 'Reconcile cancelled'; return; }
          sessionStorage.setItem('reconcile_token', token);
          body.token = token;
          r = await fetch('/api/reconcile',{method:'POST', headers: headers, body: JSON.stringify(body)});
        }
        const j = await r.json();
        if(j.ok){
          const res = j.result || {};
          const msg = `Reconcile finished: updated=${res.updated||0} removed=${res.removed||0} ${res.error?('| error:'+res.error):''}`;
          if($('terminal')) $('terminal').textContent = msg;
          pollStatus();
        } else {
          if(j.error && j.error === 'unauthorized'){
            sessionStorage.removeItem('reconcile_token');
            if($('terminal')) $('terminal').textContent = 'Reconcile unauthorized. Please log in as admin or provide correct token.';
          } else {
            if($('terminal')) $('terminal').textContent = 'Reconcile failed: ' + (j.error || JSON.stringify(j));
          }
        }
      }catch(e){ if($('terminal')) $('terminal').textContent = 'Reconcile call failed'; }
    };
  }
  </script>
  <!-- Pure JS Config Modal -->
  <div id="config_modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:12px 10px 8px 10px;border-radius:13px;min-width:260px;max-width:380px;width:98vw;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;max-height:96vh;overflow-y:auto;font-size:13px;">
      <h2 style="margin-top:0;margin-bottom:12px;font-size:1.1em;">Configuration</h2>
      <form id="config_form" autocomplete="off">
        <div id="config_fields"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
          <button type="button" id="config_apply_btn" style="background:#2563eb;color:#fff;">Apply</button>
          <button type="button" id="config_restore_btn">Restore Default</button>
          <button type="button" id="config_cancel_btn">Cancel</button>
        </div>
        <div id="config_msg" style="color:#c00;margin-top:8px;font-size:12px;"></div>
      </form>
        <div style="padding:8px 0 6px 0;display:flex;align-items:center;gap:8px;">
          <label style="font-size:13px;display:flex;align-items:center;gap:8px;"><input id="config_restart_after_apply" type="checkbox" checked /> Restart bot after apply</label>
        </div>
      <button id="config_close_btn" style="position:absolute;top:6px;right:10px;font-size:1.2em;background:none;border:none;color:#888;">&times;</button>
    </div>
  </div>
  <script src="./config_api.js"></script>
  <script>
  // --- Pure JS Config Modal Logic ---
  const CONFIG_FIELDS = [
    {k:'SYMBOL', type:'select', options:['BTCUSDT','ETHUSDT','BNBUSDT']},
    {k:'INTERVAL', type:'select', options:['1m','5m','15m','1h','4h','1d']},
    {k:'HISTORY_PRELOAD', type:'int', min:100, max:5000},
    {k:'BUY_USDT_PER_TRADE', type:'float', min:1, max:10000},
    {k:'MIN_USDT_BAL', type:'float', min:1, max:10000},
    {k:'MIN_PROFIT_TO_CLOSE', type:'float', min:0.001, max:0.1},
    {k:'FAST_SMA', type:'int', min:2, max:50},
    {k:'SLOW_SMA', type:'int', min:5, max:200},
    {k:'ATR_LEN', type:'int', min:5, max:50},
    {k:'EMA_HTF', type:'int', min:20, max:500},
    {k:'ATR_SL_MULT', type:'float', min:0.1, max:10},
    {k:'ATR_TP_MULT', type:'float', min:0.1, max:10},
    {k:'AI_MIN_CONFIDENCE_OVERRIDE', type:'float', min:0.5, max:1.0},
    {k:'AI_OVERRIDE_PROB', type:'float', min:0.5, max:1.0},
    {k:'INDICATOR_CONFIRM_COUNT', type:'int', min:1, max:5},
    {k:'MIN_COMBINED_SCORE', type:'float', min:0.0, max:1.0},
    {k:'MIN_AI_WEIGHT', type:'float', min:0.0, max:1.0},
    {k:'WIN_PROB_MIN', type:'float', min:0.5, max:1.0},
  ];
  const CONFIG_DEFAULTS = {
    SYMBOL:'BTCUSDT', INTERVAL:'5m', HISTORY_PRELOAD:600, BUY_USDT_PER_TRADE:10, MIN_USDT_BAL:20, MIN_PROFIT_TO_CLOSE:0.015,
    FAST_SMA:9, SLOW_SMA:21, ATR_LEN:14, EMA_HTF:200, ATR_SL_MULT:1.0, ATR_TP_MULT:1.0,
    AI_MIN_CONFIDENCE_OVERRIDE:0.75, AI_OVERRIDE_PROB:0.85, INDICATOR_CONFIRM_COUNT:2, MIN_COMBINED_SCORE:0.05, MIN_AI_WEIGHT:0.0, WIN_PROB_MIN:0.75
  };
  // Add adaptive toggle default
  CONFIG_DEFAULTS.ADAPTIVE_ENABLED = false;
  // Adaptive tuning defaults
  CONFIG_DEFAULTS.ADAPT_MIN_THRESH = 0.55;
  CONFIG_DEFAULTS.ADAPT_MAX_THRESH = 0.95;
  CONFIG_DEFAULTS.ADAPT_BASE_FRAC = 0.02;
  let configCache = {};
  function showConfigModal() {
    const modal = document.getElementById('config_modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    loadConfigFields();
  }
  function hideConfigModal() {
    document.getElementById('config_modal').style.display = 'none';
    document.body.style.overflow = '';
    document.getElementById('config_msg').textContent = '';
  }
  function loadConfigFields() {
    fetch('/api/config').then(r=>r.json()).then(cfg=>{
      configCache = {...CONFIG_DEFAULTS, ...cfg};
      const fields = document.getElementById('config_fields');
      fields.innerHTML = '';
      CONFIG_FIELDS.forEach(f=>{
        // Always use current config value if present, else default
        const v = (cfg && (cfg[f.k] !== undefined && cfg[f.k] !== null && cfg[f.k] !== '')) ? cfg[f.k] : CONFIG_DEFAULTS[f.k];
        let html = `<div style='display:flex;align-items:center;gap:8px;margin-bottom:7px;'>`;
        html += `<label for='cf_${f.k}' style='font-weight:500;min-width:170px;'>${f.k} ${(f.min!==undefined?`<span style='color:#888;font-size:11px;'>(min:${f.min}`:'')}${f.max!==undefined?`, max:${f.max}`:''}${(f.min!==undefined?')':'')}</span></label>`;
        if(f.type==='select'){
          html += `<select id='cf_${f.k}' style='flex:1;'>${f.options.map(opt=>`<option value='${opt}'${v==opt?' selected':''}>${opt}</option>`).join('')}</select>`;
        }else{
          html += `<input id='cf_${f.k}' type='number' value='${v}' min='${f.min}' max='${f.max}' step='${f.type==='int'?1:0.001}' style='width:80px;' />`;
        }
        html += `</div>`;
        fields.innerHTML += html;
      });
        // Append ADAPTIVE_ENABLED checkbox (not part of numeric CONFIG_FIELDS)
        try{
          const adaptiveValRaw = (cfg && (cfg['ADAPTIVE_ENABLED'] !== undefined && cfg['ADAPTIVE_ENABLED'] !== null && cfg['ADAPTIVE_ENABLED'] !== '')) ? cfg['ADAPTIVE_ENABLED'] : CONFIG_DEFAULTS['ADAPTIVE_ENABLED'];
          const adaptiveVal = (adaptiveValRaw === true || String(adaptiveValRaw).toLowerCase() === 'true');
          const chkHtml = `<div style='display:flex;align-items:center;gap:8px;margin-bottom:7px;'><label for='cf_ADAPTIVE_ENABLED' style='font-weight:500;min-width:170px;'>ADAPTIVE_ENABLED</label><input id='cf_ADAPTIVE_ENABLED' type='checkbox' ${adaptiveVal? 'checked':''} /></div>`;
          fields.innerHTML += chkHtml;
          // Add adaptive tuning fields under the toggle (they can be enabled when ADAPTIVE_ENABLED is checked)
          const minVal = (cfg && cfg['ADAPT_MIN_THRESH']!==undefined)?cfg['ADAPT_MIN_THRESH']:CONFIG_DEFAULTS.ADAPT_MIN_THRESH;
          const maxVal = (cfg && cfg['ADAPT_MAX_THRESH']!==undefined)?cfg['ADAPT_MAX_THRESH']:CONFIG_DEFAULTS.ADAPT_MAX_THRESH;
          const baseVal = (cfg && cfg['ADAPT_BASE_FRAC']!==undefined)?cfg['ADAPT_BASE_FRAC']:CONFIG_DEFAULTS.ADAPT_BASE_FRAC;
          const adaptHtml = `
            <div id='adaptive_fields' style='margin-left:6px;margin-bottom:8px;'>
              <div style='display:flex;align-items:center;gap:8px;margin-bottom:6px;'><label style='min-width:170px;color:#666;'>ADAPT_MIN_THRESH</label><input id='cf_ADAPT_MIN_THRESH' type='number' step='0.01' value='${minVal}' style='width:80px;' /></div>
              <div style='display:flex;align-items:center;gap:8px;margin-bottom:6px;'><label style='min-width:170px;color:#666;'>ADAPT_MAX_THRESH</label><input id='cf_ADAPT_MAX_THRESH' type='number' step='0.01' value='${maxVal}' style='width:80px;' /></div>
              <div style='display:flex;align-items:center;gap:8px;margin-bottom:6px;'><label style='min-width:170px;color:#666;'>ADAPT_BASE_FRAC</label><input id='cf_ADAPT_BASE_FRAC' type='number' step='0.001' value='${baseVal}' style='width:80px;' /></div>
            </div>`;
          fields.innerHTML += adaptHtml;
          // Wire checkbox change event to enable/disable adaptive inputs
          try{
            const cb = document.getElementById('cf_ADAPTIVE_ENABLED');
            if(cb) {
              cb.addEventListener('change', function(){ try{ setAdaptiveFieldsState(cb.checked); }catch(e){} });
            }
          }catch(e){}
          // Set initial enabled/disabled state
          setTimeout(()=>{
            try{ const cb2 = document.getElementById('cf_ADAPTIVE_ENABLED'); if(cb2) setAdaptiveFieldsState(cb2.checked); }catch(e){}
          }, 10);
        }catch(e){ }
    });
  }
  // Enable or disable adaptive tuning inputs when ADAPTIVE_ENABLED toggles
  function setAdaptiveFieldsState(enabled){
    try{
      const ids = ['cf_ADAPT_MIN_THRESH','cf_ADAPT_MAX_THRESH','cf_ADAPT_BASE_FRAC'];
      ids.forEach(id=>{ const el = document.getElementById(id); if(el) el.disabled = !enabled; });
      // Adjust label color to visually indicate disabled state
      const labels = document.querySelectorAll('#adaptive_fields label');
      labels.forEach(l=>{ l.style.color = enabled ? '#000' : '#888'; });
    }catch(e){}
  }
  function validateConfig() {
    let ok = true, msg = '';
    CONFIG_FIELDS.forEach(f=>{
      const el = document.getElementById('cf_'+f.k);
      let v = el.value;
      if(f.type==='select') return; // skip select fields, always valid
      if(f.type==='int') v = parseInt(v);
      else if(f.type==='float') v = parseFloat(v);
      if(f.min!==undefined && v<f.min) { ok=false; msg+=`${f.k} < min; `; }
      if(f.max!==undefined && v>f.max) { ok=false; msg+=`${f.k} > max; `; }
      if(f.type==='int' && !Number.isInteger(v)) { ok=false; msg+=`${f.k} not int; `; }
      if(isNaN(v)) { ok=false; msg+=`${f.k} invalid; `; }
    });
    document.getElementById('config_msg').textContent = ok?'':msg;
    return ok;
  }
  document.getElementById('config_btn').onclick = showConfigModal;
  document.getElementById('config_close_btn').onclick = hideConfigModal;
  document.getElementById('config_cancel_btn').onclick = hideConfigModal;
  document.getElementById('config_restore_btn').onclick = function(){
    CONFIG_FIELDS.forEach(f=>{
      const el = document.getElementById('cf_'+f.k);
      el.value = CONFIG_DEFAULTS[f.k];
    });
    try{ document.getElementById('cf_ADAPTIVE_ENABLED').checked = CONFIG_DEFAULTS['ADAPTIVE_ENABLED']; }catch(e){}
    document.getElementById('config_msg').textContent = 'Restored default values (not saved yet)';
  };
    document.getElementById('config_apply_btn').onclick = async function(){
    if(!validateConfig()) return;
    const vals = {};
    CONFIG_FIELDS.forEach(f=>{
      let v = document.getElementById('cf_'+f.k).value;
      if(f.type==='int') v = parseInt(v);
      else if(f.type==='float') v = parseFloat(v);
      vals[f.k] = v;
    });
  // include adaptive toggle
  try{ vals['ADAPTIVE_ENABLED'] = (document.getElementById('cf_ADAPTIVE_ENABLED') && document.getElementById('cf_ADAPTIVE_ENABLED').checked) ? 'true' : 'false'; }catch(e){}
  // include adaptive tuning values (always send current values so backend persists them)
  try{ vals['ADAPT_MIN_THRESH'] = parseFloat(document.getElementById('cf_ADAPT_MIN_THRESH').value); }catch(e){}
  try{ vals['ADAPT_MAX_THRESH'] = parseFloat(document.getElementById('cf_ADAPT_MAX_THRESH').value); }catch(e){}
  try{ vals['ADAPT_BASE_FRAC'] = parseFloat(document.getElementById('cf_ADAPT_BASE_FRAC').value); }catch(e){}
    try{
      const res = await fetch('/api/config', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(vals)});
      const j = await res.json();
      if(j.ok){
        // Optionally restart bot to apply runtime-sensitive changes (preload, etc.)
        const shouldRestart = document.getElementById('config_restart_after_apply') && document.getElementById('config_restart_after_apply').checked;
        if(shouldRestart){
          try{ await fetch('/api/stop', {method:'POST'}); }catch(e){}
          try{ await fetch('/api/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({netmode: document.querySelector('input[name="netmode"]:checked').value})}); }catch(e){}
        }
        hideConfigModal(); location.reload();
      } else {
        document.getElementById('config_msg').textContent = j.msg||'Failed to save config';
      }
    }catch(e){ document.getElementById('config_msg').textContent = 'Failed to save config'; }
  };
  // ESC to close
  window.addEventListener('keydown', function(e){
    if(e.key==='Escape') hideConfigModal();
  });
  </script>
  </div>
  <!-- Removed duplicate Change Password and Logout buttons from login screen -->
    </div>

    <div id="equity_plot" style="margin-top:40px;max-width:700px;"></div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Helper is defined earlier near the top of the document to allow early scripts to use `$()`.

    // Open profit report if button exists
    if($('profit_report_btn')) {
      $('profit_report_btn').onclick = ()=> window.open('/api/profit_report', '_blank');
    }

    // Login form submit handler (only one)
    const loginForm = $('login_form');
    if(loginForm){
      loginForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const email = $('login_email').value.trim();
        const password = $('login_password').value;
        const msg = $('login_msg');
        msg.textContent = '';
        if(!email || !password){ msg.textContent = 'Please enter both email and password.'; return; }
        try{
          const res = await fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password})});
          const data = await res.json();
          if(data.success){
            // mark logged in and show main UI
            localStorage.setItem('bot_logged_in','1');
            try{ localStorage.setItem('bot_user_email', email); }catch(e){}
            // update displayed email immediately
            const lin = $('logged_in_as'); if(lin) lin.textContent = email;
            // Clear login fields after successful login
            if($('login_email')) $('login_email').value = '';
            if($('login_password')) $('login_password').value = '';
            if(typeof restoreUI === 'function') restoreUI();
            if(typeof refresh === 'function') refresh();
          } else {
            msg.textContent = data.message || 'Login failed.';
          }
        }catch(err){ msg.textContent = 'Server error.'; }
      });
    }

    // Utility: show/hide main/login UI (use explicit display values)
    function showMainUI(){ if($('.dashboard-container')) $('.dashboard-container').style.display='flex'; if($('main_card')) $('main_card').style.display='flex'; if($('side_btns')) $('side_btns').style.display='flex'; if($('login_section')) $('login_section').style.display='none'; }
    function showLoginUI(){ if($('.dashboard-container')) $('.dashboard-container').style.display='none'; if($('main_card')) $('main_card').style.display='none'; if($('side_btns')) $('side_btns').style.display='none'; if($('login_section')) $('login_section').style.display='flex'; }

    // restore UI from localStorage (always show dashboard if logged in)
    function restoreUI(){
      if(localStorage.getItem('bot_logged_in')){
        showMainUI();
        const email = localStorage.getItem('bot_user_email'); if(email){ const el = $('logged_in_as'); if(el) el.textContent = email; }
      } else {
        showLoginUI();
      }
    }
    // On page load and after login, query server to get authoritative session state and update UI
    async function refreshSession() {
      try {
        const r = await fetch('/api/whoami');
        const j = await r.json();
        if(j.logged_in){
          localStorage.setItem('bot_logged_in','1');
          try{ localStorage.setItem('bot_user_email', j.email || ''); }catch(e){}
          if($('logged_in_as')) $('logged_in_as').textContent = j.email || '';
        } else {
          localStorage.removeItem('bot_logged_in');
          try{ localStorage.removeItem('bot_user_email'); }catch(e){}
          if($('logged_in_as')) $('logged_in_as').textContent = '...';
        }
        // enable/disable reconcile button based on server session
        const recBtn = $('reconcile_btn'); if(recBtn) recBtn.disabled = !j.logged_in;
      } catch(e) {
        // network or server error - leave local state as-is
      }
  }
  // call now and periodically refresh session state, and use it to decide which UI to show
  (async function(){ await refreshSession(); restoreUI(); })();
  setInterval(refreshSession, 15000);

    // Attach logout handler (main and side)
  if($('logout_btn')) $('logout_btn').onclick = async ()=>{
    try{ await fetch('/api/logout', {method:'POST'}); }catch(e){}
    localStorage.removeItem('bot_logged_in');
    try{ localStorage.removeItem('bot_user_email'); }catch(e){};
    if($('logged_in_as')) $('logged_in_as').textContent = '...';
    // Clear login fields after logout
    if($('login_email')) $('login_email').value = '';
    if($('login_password')) $('login_password').value = '';
    showLoginUI();
  };
  if($('logout_btn_side')) $('logout_btn_side').onclick = async ()=>{
    try{ await fetch('/api/logout', {method:'POST'}); }catch(e){}
    localStorage.removeItem('bot_logged_in');
    try{ localStorage.removeItem('bot_user_email'); }catch(e){};
    if($('logged_in_as')) $('logged_in_as').textContent = '...';
    // Clear login fields after logout
    if($('login_email')) $('login_email').value = '';
    if($('login_password')) $('login_password').value = '';
    showLoginUI();
  };

    // Change password handler (main and side)
    if($('change_pw_btn')){
      $('change_pw_btn').onclick = async ()=>{
        const email = prompt('Enter your email:');
        const oldpw = prompt('Enter current password:');
        const newpw = prompt('Enter new password:');
        if(!email||!oldpw||!newpw) return alert('All fields required!');
        try{
          const r = await fetch('/api/change_password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,old_password:oldpw,new_password:newpw})});
          const j = await r.json();
          alert(j.success? 'Password updated' : ('Error: ' + (j.message||'Failed')));
        }catch(e){ alert('Server error'); }
      };
    }
    if($('change_pw_btn_side')){
      $('change_pw_btn_side').onclick = async ()=>{
        const email = prompt('Enter your email:');
        const oldpw = prompt('Enter current password:');
        const newpw = prompt('Enter new password:');
        if(!email||!oldpw||!newpw) return alert('All fields required!');
        try{
          const r = await fetch('/api/change_password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,old_password:oldpw,new_password:newpw})});
          const j = await r.json();
          alert(j.success? 'Password updated' : ('Error: ' + (j.message||'Failed')));
        }catch(e){ alert('Server error'); }
      };
    }

    // Safe attach for equity plot button
    if($('equity_plot_btn')) $('equity_plot_btn').onclick = async ()=>{
      try{
        await plotEquityCurve();
      }catch(e){
        const eqDiv = document.getElementById('equity_plot');
        if(eqDiv) eqDiv.innerHTML = '<span style="color:#c00">Equity Curve plot error!</span>';
      }
    };

    // Safe attach for signal/retrain buttons
    if($('signal_btn')) $('signal_btn').onclick = async ()=>{
      if($('terminal')) $('terminal').textContent = 'Running debug_signal.py...';
      const r = await fetch('/api/run_debug_signal'); const j = await r.json(); if($('terminal')) $('terminal').textContent = j.output||'No output.';
    };
    if($('retrain_btn')) $('retrain_btn').onclick = async ()=>{
      if($('terminal')) $('terminal').textContent = 'Running train_model.py...';
      const r = await fetch('/api/run_retrain'); const j = await r.json(); if($('terminal')) $('terminal').textContent = j.output||'No output.';
    };

    // Start / Stop bot handlers
    if($('start')) $('start').onclick = async ()=>{
      const btn = $('start');
      if(btn) { btn.disabled = true; btn.dataset.orig = btn.textContent; btn.textContent = 'Starting...'; }
      if($('terminal')) $('terminal').textContent = 'Starting bot...';
      // read netmode
      let netmode = 'testnet'; const n = document.querySelector('input[name="netmode"]:checked'); if(n) netmode = n.value;
      try{
        const r = await fetch('/api/start',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({netmode})});
        const j = await r.json();
        if($('terminal')) {
          let out = j.msg || j.message || JSON.stringify(j);
          // show reconcile result if present
          if(j.reconcile) out += '\nReconcile: updated=' + (j.reconcile.updated||0) + ' removed=' + (j.reconcile.removed||0) + (j.reconcile.error?(' error='+j.reconcile.error):'');
          $('terminal').textContent = out;
        }
        if(j.ok || j.success) $('status').textContent = 'running';
      }catch(e){ if($('terminal')) $('terminal').textContent = 'Error starting bot'; }
      finally{ if(btn){ btn.disabled = false; btn.textContent = btn.dataset.orig || 'Start Bot'; }}
    };
    if($('stop')) $('stop').onclick = async ()=>{
      const btn = $('stop');
      if(btn) { btn.disabled = true; btn.dataset.orig = btn.textContent; btn.textContent = 'Stopping...'; }
      if($('terminal')) $('terminal').textContent = 'Stopping bot...';
      try{
        const r = await fetch('/api/stop',{method:'POST'}); const j = await r.json();
        if($('terminal')) $('terminal').textContent = j.msg || j.message || JSON.stringify(j);
        if(j.ok || j.success) $('status').textContent = 'stopped';
      }catch(e){ if($('terminal')) $('terminal').textContent = 'Error stopping bot'; }
      finally{ if(btn){ btn.disabled = false; btn.textContent = btn.dataset.orig || 'Stop Bot'; }}
    };

    // --- Real-time status update using Socket.IO + fallback polling ---
  // --- Equity Curve Plot Logic ---
  async function plotEquityCurve() {
    const eqDiv = document.getElementById('equity_plot');
    if(eqDiv) eqDiv.innerHTML = '<span style="color:#2563eb">Loading Equity Curve...</span>';
    let url = '/api/trade_history';
    try {
      const res = await fetch(url);
      const j = await res.json();
      let trades = j.trades || [];
      if (!Array.isArray(trades)) trades = [];
      // Equity curve calculation
      let equity = 0, curve = [];
      for (const t of trades) {
        equity += (parseFloat(t.realized_pnl_usdt)||0);
        curve.push({ts: t.timestamp || '', eq: equity});
      }
      if(curve.length === 0) {
        if(eqDiv) eqDiv.innerHTML = '<span style="color:#c00">No trades found for equity curve.</span>';
        return;
      }
      // Simple plot using HTML table (no chart lib)
      // Use a thead/tbody structure and fixed layout so headers align above columns.
      let html = '<table style="width:100%;max-width:700px;border-collapse:collapse;margin-top:8px;font-size:13px;table-layout:fixed;">';
      html += '<thead><tr>' +
        '<th style="width:55%;text-align:left;padding:6px;border:1px solid #e6e6e6;background:#f7fafc">Time</th>' +
        '<th style="width:45%;text-align:right;padding:6px;border:1px solid #e6e6e6;background:#f7fafc">Equity (USDT)</th>' +
        '</tr></thead><tbody>';
      for(const pt of curve) html += `<tr><td style="padding:6px;border:1px solid #f1f5f9;white-space:nowrap;">${pt.ts}</td><td style="padding:6px;border:1px solid #f1f5f9;text-align:right;">${pt.eq.toFixed(2)}</td></tr>`;
      html += '</tbody></table>';
      eqDiv.innerHTML = html;
    } catch(e) {
      if(eqDiv) eqDiv.innerHTML = '<span style="color:#c00">Failed to load equity curve.</span>';
    }
  }
    function updateStatusUI(s) {
      try{ console.log('[UI] updateStatusUI received:', s); }catch(e){}
      if($('status')) $('status').textContent = s.running? 'running' : 'stopped';
      // Only update balances when a real balance event occurs (e.g. trade exec/close)
      // or on the initial UI population to avoid flip-flopping between N/A and values.
      try {
        if (!window._balanceInitialized || s.balance_event === true) {
          if($('bal_usdt')) $('bal_usdt').textContent = s.usdt || '...';
          if($('bal_btc')) $('bal_btc').textContent = s.btc || '...';
          window._balanceInitialized = true;
        }
      } catch (e) {}
      if($('win')) $('win').textContent = s.win!==undefined? s.win : '...';
      if($('loss')) $('loss').textContent = s.loss!==undefined? s.loss : '...';
      if($('pnl')) $('pnl').textContent = s.pnl!==undefined? s.pnl : '...';
      if($('pending')) $('pending').textContent = s.pending!==undefined? s.pending : '...';
      if($('pending_amt')) $('pending_amt').textContent = s.pending_amt!==undefined? s.pending_amt : '...';
      if($('terminal') && s.terminal) $('terminal').textContent = s.terminal;
      // Remove auto-forcing radio unless status update is from backend change
      // Only update radio if netmode change was not user-initiated
      if(window._netmodeChanging !== true) {
        try{ if(typeof s.use_testnet !== 'undefined'){ const val = s.use_testnet? 'testnet':'mainnet'; const el = document.querySelector('input[name="netmode"][value="'+val+'"]'); if(el) el.checked = true; } }catch(e){}
      }
      window._netmodeChanging = false;
    }
    // Netmode radio change handler
    document.getElementById('netmode_testnet').addEventListener('change', function(e){
      if(this.checked){
        window._netmodeChanging = true;
        fetch('/api/set_netmode', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({netmode:'testnet'})})
          .then(r=>r.json()).then(j=>{ pollStatus(); });
      }
    });
    document.getElementById('netmode_mainnet').addEventListener('change', function(e){
      if(this.checked){
        window._netmodeChanging = true;
        fetch('/api/set_netmode', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({netmode:'mainnet'})})
          .then(r=>r.json()).then(j=>{ pollStatus(); });
      }
    });
    async function pollStatus() {
      try {
        const r = await fetch('/api/status');
        const s = await r.json();
        updateStatusUI(s);
      } catch(e) {}
    }
    // Initial fetch on page load
    pollStatus();
    // Poll every 3s as fallback
    setInterval(pollStatus, 3000);
    // Socket.IO for instant updates
    (function(){
      var s=document.createElement('script');
      s.src='https://cdn.socket.io/4.7.5/socket.io.min.js';
      s.onload=function(){
        try{
          // Prefer connecting to the same origin that served the page. This
          // avoids forcing a different port (like :5000) when the backend is
          // actually hosted on the same port as the UI (e.g. :8000). If an
          // explicit WEBUI_BACKEND_URL is provided by the server, use it.
          var backendUrl = window.WEBUI_BACKEND_URL || window.__WEBUI_BACKEND_URL__ || window.location.origin;
          // Prefer polling first (more robust in development hosts); then allow websocket.
          var socket = io(backendUrl, { transports: ['polling','websocket'] });
          socket.on('connect_error', function(err){ try{ console.warn('[SOCKET] connect_error to', backendUrl, err); }catch(e){} });
          socket.on('connect', function(){ try{ console.log('[SOCKET] connected to', backendUrl); }catch(e){} });
          socket.on('status_update', function(s){
            try{ console.log('[SOCKET] status_update', s); }catch(e){}
            updateStatusUI(s);
          });
          socket.on('disconnect', function(){ try{ console.log('[SOCKET] disconnected'); }catch(e){} });
        }catch(e){ console.error('Socket init failed', e); }
      };
      document.head.appendChild(s);
    })();
  </script>
  </body>
</html>
