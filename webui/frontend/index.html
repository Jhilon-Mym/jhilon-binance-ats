<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Binance Bot UI</title>
    <style>
  /* Allow wider layout so dashboard can use left area and side buttons on the right */
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:1280px;margin:12px auto;padding:0 12px;background:#fff;height:100vh;overflow:hidden}
  .card{border:1px solid #eee;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 3px 12px rgba(10,12,14,.05);background:#fff}

  /* Login form tweaks */
  #login_form{width:380px;box-shadow:0 10px 30px rgba(10,12,14,0.06);padding:26px;border-radius:12px}
  #login_form input{width:100%;margin-bottom:10px;padding:10px 12px;border-radius:10px;border:1px solid #e3e3e3;font-size:14px}
  #login_btn{width:100%;padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(180deg,#3b82f6,#2563eb);color:#fff;font-weight:600;box-shadow:0 8px 20px rgba(37,99,235,0.12)}

  /* Base button style */
  button{padding:8px 12px;border-radius:8px;border:1px solid #d1d1d1;background:linear-gradient(#ffffff,#f2f2f2);box-shadow:0 3px 0 rgba(0,0,0,0.03);cursor:pointer;font-family:inherit;color:#222;transition:all .12s ease-in-out}
  button:hover{ transform:translateY(-2px); box-shadow:0 10px 26px rgba(15,20,25,0.06); }

  /* Side column buttons slightly larger and left-aligned text */
  #side_btns button{background: linear-gradient(#f9f9f9,#f3f3f3);border-radius:10px;padding:10px 14px;text-align:left;box-shadow: 0 2px 6px rgba(0,0,0,0.04);font-size:14px;width:220px}

  /* Start/Stop small primary style - grouped on top-left */
  .top-controls{display:flex;gap:8px;align-items:center}
  #start, #stop{ padding:6px 10px; font-size:13px;border-radius:8px }

  /* Logout highlight */
  #logout_btn, #logout_btn_side{ background: linear-gradient(#fdecea,#f7d7d7); border-color:#e8bfbf; }

  .row{display:flex;gap:12px;align-items:center}
  h1.page-title{font-size:28px;text-align:center;margin:6px 0 4px 0;letter-spacing:0.5px}
  .sub-title{font-size:12px;color:#666;text-align:center;margin-bottom:16px}
  code{background:#f6f8fa;padding:2px 6px;border-radius:6px}

  /* Dashboard layout rules */
  .dashboard-container{display:flex;align-items:flex-start;gap:20px;position:relative}
  /* Keep main card responsive but leave space for the fixed right-side controls (220px + gap)
    This prevents the terminal from flowing underneath the side buttons on narrower viewports. */
  #main_card{flex:1;min-width:320px;max-width:calc(100% - 260px)}

  /* Terminal style: show single-line log entries (no wrap) and allow horizontal + vertical scrolling */
  /* Terminal: smaller height, full width inside the main card and force scrollbars (both axes)
    so users can scroll horizontally and vertically to read long log lines. No wrapping. */
  #terminal{
    font-family:'Fira Mono','Consolas','Menlo','Monospace';
    font-size:13px;
    background:#1f2937;
    color:#e6eef8;
    padding:12px;
    border-radius:12px;
    height:220px;
    max-height:320px;
    min-width:0;
    width:100%;
    overflow:auto;
    white-space:pre-wrap;
    word-break:break-all;
    box-shadow:inset 0 -6px 18px rgba(0,0,0,0.12);
    box-sizing:border-box;
    scrollbar-gutter:stable;
    border:1.5px solid #d1d5db;
  }

  /* Remove the thin red divider (hidden) — handled visually by spacing now */
  .divider{display:none}

  /* Make the side buttons column fixed on the right for a floating control panel */
  #side_btns{position:fixed;right:18px;top:120px;display:flex;flex-direction:column;gap:12px;z-index:30}

  /* responsive tweaks */
  @media(max-width:900px){ #side_btns{position:static;width:100%;flex-direction:row;overflow:auto} #main_card{min-width:0} }
    </style>
  </head>
  <body>
  <div id="login_section" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:90vh;">
      <form id="login_form" style="width:370px;" autocomplete="off" onsubmit="return false;">
  <div style="font-size:2em;font-weight:bold;text-align:center;margin-bottom:0;white-space:nowrap;display:flex;justify-content:center;">Binance Auto Trading Bot</div>
  <div style="font-size:1em;color:#555;margin-bottom:30px;text-align:center;display:flex;justify-content:center;">(ATS Pro ensures your success in trading)</div>
        <div style="font-weight:bold;text-align:center;margin-bottom:8px;font-size:1.1em;">Login</div>
        <input id="login_email" type="email" placeholder="Email" style="width:100%;margin-bottom:7px;padding:4px;" autocomplete="username" required />
        <input id="login_password" type="password" placeholder="Password" style="width:100%;margin-bottom:7px;padding:4px;" autocomplete="current-password" required />
  <button id="login_btn" type="submit" style="width:60%;margin:0 auto 7px auto;padding:7px 0 7px 0;background:#2563eb;border:1px solid #1e40af;border-radius:7px;color:#fff;font-weight:600;font-size:1.08em;display:block;letter-spacing:0.5px;">Login</button>
        <div id="login_msg" style="color:red;margin-top:8px;text-align:center;"></div>
        <div style="margin-top:60px;font-size:15px;text-align:center;color:#222;">
          © 2025-2030, The Auto Trade Solutions (ATS Pro)
        </div>
      </form>
    </div>
  <!-- Dashboard layout: left main card + right side buttons -->
  <div class="dashboard-container" style="display:none;align-items:flex-start;gap:20px;">
  <div id="main_card" class="card" style="flex-direction:column;gap:10px;flex:1;">
      <!-- Top info row: left=start/stop+summary, center=balances, right=netmode + logged in -->
      <div class="card" style="padding:12px;display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px;">
        <div style="flex:1;min-width:220px;">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
            <button id="start" style="margin-right:6px;padding:6px 10px">Start Bot</button>
            <button id="stop" style="padding:6px 10px">Stop Bot</button>
            <div style="margin-left:10px;font-weight:600;">Status: <span id="status">...</span></div>
          </div>
          <div>
            <b>Summary:</b><br>
            Total Win: <span id="win">...</span> &nbsp; Total Loss: <span id="loss">...</span> &nbsp; PnL: <span id="pnl">...</span>
          </div>
        </div>
        <div style="flex:0 0 280px;text-align:center;">
          <b>Available Balance:</b><br>
          USDT: <span id="bal_usdt">...</span><br>
          BTC: <span id="bal_btc">...</span>
        </div>
        <div style="flex:0 0 220px;text-align:right;">
          <div style="margin-bottom:8px;font-weight:600;">Net Mode:</div>
          <div style="text-align:right;">
            <label><input type="radio" name="netmode" value="testnet" checked> Testnet</label><br>
            <label><input type="radio" name="netmode" value="mainnet"> Mainnet</label>
          </div>
          <div style="margin-top:8px;text-align:right;color:#444;">Logged in as: <span id="logged_in_as">...</span></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div style="flex:1;">
          <b>Terminal Output:</b>
          <div class="divider" aria-hidden="true"></div>
          <div id="terminal"></div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div>Pending Trades: <span id="pending">...</span> &nbsp; Pending Amount (in USDT): <span id="pending_amt">...</span></div>
      </div>
    </div>
    <!-- Right-side action buttons column -->
  <div id="side_btns" style="display:flex;flex-direction:column;gap:10px;z-index:20;width:220px;align-self:flex-start;">
      <button id="config_btn" style="padding:8px 10px;font-size:13px;text-align:left;font-weight:bold;background:#e0f7fa;">Configuration</button>
      <button id="signal_btn" style="padding:8px 10px;font-size:13px;text-align:left;">Signal Debug</button>
      <button id="retrain_btn" style="padding:8px 10px;font-size:13px;text-align:left;">Bot Re-Train</button>
      <button id="profit_report_btn" style="padding:8px 10px;font-size:13px;text-align:left;">Download Profit Report (CSV)</button>
      <button id="equity_plot_btn" style="padding:8px 10px;font-size:13px;text-align:left;">Show Equity Curve</button>
      <button id="change_pw_btn_side" style="padding:8px 10px;font-size:13px;text-align:left;border-radius:8px">Change Password</button>
      <button id="logout_btn_side" style="padding:8px 10px;font-size:13px;background:#f3d6d6;text-align:left;border-radius:8px">Logout</button>
    </div>
  <!-- Pure JS Config Modal -->
  <div id="config_modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:12px 10px 8px 10px;border-radius:13px;min-width:260px;max-width:380px;width:98vw;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;max-height:96vh;overflow-y:auto;font-size:13px;">
      <h2 style="margin-top:0;margin-bottom:12px;font-size:1.1em;">Configuration</h2>
      <form id="config_form" autocomplete="off">
        <div id="config_fields"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
          <button type="button" id="config_apply_btn" style="background:#2563eb;color:#fff;">Apply</button>
          <button type="button" id="config_restore_btn">Restore Default</button>
          <button type="button" id="config_cancel_btn">Cancel</button>
        </div>
        <div id="config_msg" style="color:#c00;margin-top:8px;font-size:12px;"></div>
      </form>
      <button id="config_close_btn" style="position:absolute;top:6px;right:10px;font-size:1.2em;background:none;border:none;color:#888;">&times;</button>
    </div>
  </div>
  <script src="./config_api.js"></script>
  <script>
  // --- Pure JS Config Modal Logic ---
  const CONFIG_FIELDS = [
    {k:'SYMBOL', type:'select', options:['BTCUSDT','ETHUSDT','BNBUSDT']},
    {k:'INTERVAL', type:'select', options:['1m','5m','15m','1h','4h','1d']},
    {k:'HISTORY_PRELOAD', type:'int', min:100, max:5000},
    {k:'BUY_USDT_PER_TRADE', type:'float', min:1, max:10000},
    {k:'MIN_USDT_BAL', type:'float', min:1, max:10000},
    {k:'MIN_PROFIT_TO_CLOSE', type:'float', min:0.001, max:0.1},
    {k:'FAST_SMA', type:'int', min:2, max:50},
    {k:'SLOW_SMA', type:'int', min:5, max:200},
    {k:'ATR_LEN', type:'int', min:5, max:50},
    {k:'EMA_HTF', type:'int', min:20, max:500},
    {k:'ATR_SL_MULT', type:'float', min:0.1, max:10},
    {k:'ATR_TP_MULT', type:'float', min:0.1, max:10},
    {k:'AI_MIN_CONFIDENCE_OVERRIDE', type:'float', min:0.5, max:1.0},
    {k:'AI_OVERRIDE_PROB', type:'float', min:0.5, max:1.0},
    {k:'INDICATOR_CONFIRM_COUNT', type:'int', min:1, max:5},
    {k:'MIN_COMBINED_SCORE', type:'float', min:0.0, max:1.0},
    {k:'MIN_AI_WEIGHT', type:'float', min:0.0, max:1.0},
    {k:'WIN_PROB_MIN', type:'float', min:0.5, max:1.0},
  ];
  const CONFIG_DEFAULTS = {
    SYMBOL:'BTCUSDT', INTERVAL:'5m', HISTORY_PRELOAD:600, BUY_USDT_PER_TRADE:10, MIN_USDT_BAL:20, MIN_PROFIT_TO_CLOSE:0.015,
    FAST_SMA:9, SLOW_SMA:21, ATR_LEN:14, EMA_HTF:200, ATR_SL_MULT:1.0, ATR_TP_MULT:1.0,
    AI_MIN_CONFIDENCE_OVERRIDE:0.75, AI_OVERRIDE_PROB:0.85, INDICATOR_CONFIRM_COUNT:2, MIN_COMBINED_SCORE:0.05, MIN_AI_WEIGHT:0.0, WIN_PROB_MIN:0.75
  };
  let configCache = {};
  function showConfigModal() {
    const modal = document.getElementById('config_modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    loadConfigFields();
  }
  function hideConfigModal() {
    document.getElementById('config_modal').style.display = 'none';
    document.body.style.overflow = '';
    document.getElementById('config_msg').textContent = '';
  }
  function loadConfigFields() {
    fetch('/api/config').then(r=>r.json()).then(cfg=>{
      configCache = {...CONFIG_DEFAULTS, ...cfg};
      const fields = document.getElementById('config_fields');
      fields.innerHTML = '';
      CONFIG_FIELDS.forEach(f=>{
        // Always use current config value if present, else default
        const v = (cfg && (cfg[f.k] !== undefined && cfg[f.k] !== null && cfg[f.k] !== '')) ? cfg[f.k] : CONFIG_DEFAULTS[f.k];
        let html = `<div style='display:flex;align-items:center;gap:8px;margin-bottom:7px;'>`;
        html += `<label for='cf_${f.k}' style='font-weight:500;min-width:170px;'>${f.k} ${(f.min!==undefined?`<span style='color:#888;font-size:11px;'>(min:${f.min}`:'')}${f.max!==undefined?`, max:${f.max}`:''}${(f.min!==undefined?')':'')}</span></label>`;
        if(f.type==='select'){
          html += `<select id='cf_${f.k}' style='flex:1;'>${f.options.map(opt=>`<option value='${opt}'${v==opt?' selected':''}>${opt}</option>`).join('')}</select>`;
        }else{
          html += `<input id='cf_${f.k}' type='number' value='${v}' min='${f.min}' max='${f.max}' step='${f.type==='int'?1:0.001}' style='width:80px;' />`;
        }
        html += `</div>`;
        fields.innerHTML += html;
      });
    });
  }
  function validateConfig() {
    let ok = true, msg = '';
    CONFIG_FIELDS.forEach(f=>{
      const el = document.getElementById('cf_'+f.k);
      let v = el.value;
      if(f.type==='select') return; // skip select fields, always valid
      if(f.type==='int') v = parseInt(v);
      else if(f.type==='float') v = parseFloat(v);
      if(f.min!==undefined && v<f.min) { ok=false; msg+=`${f.k} < min; `; }
      if(f.max!==undefined && v>f.max) { ok=false; msg+=`${f.k} > max; `; }
      if(f.type==='int' && !Number.isInteger(v)) { ok=false; msg+=`${f.k} not int; `; }
      if(isNaN(v)) { ok=false; msg+=`${f.k} invalid; `; }
    });
    document.getElementById('config_msg').textContent = ok?'':msg;
    return ok;
  }
  document.getElementById('config_btn').onclick = showConfigModal;
  document.getElementById('config_close_btn').onclick = hideConfigModal;
  document.getElementById('config_cancel_btn').onclick = hideConfigModal;
  document.getElementById('config_restore_btn').onclick = function(){
    CONFIG_FIELDS.forEach(f=>{
      const el = document.getElementById('cf_'+f.k);
      el.value = CONFIG_DEFAULTS[f.k];
    });
    document.getElementById('config_msg').textContent = 'Restored default values (not saved yet)';
  };
  document.getElementById('config_apply_btn').onclick = function(){
    if(!validateConfig()) return;
    const vals = {};
    CONFIG_FIELDS.forEach(f=>{
      let v = document.getElementById('cf_'+f.k).value;
      if(f.type==='int') v = parseInt(v);
      else if(f.type==='float') v = parseFloat(v);
      vals[f.k] = v;
    });
    fetch('/api/config', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(vals)})
      .then(r=>r.json()).then(j=>{
        if(j.ok){ hideConfigModal(); location.reload(); }
        else document.getElementById('config_msg').textContent = j.msg||'Failed to save config';
      });
  };
  // ESC to close
  window.addEventListener('keydown', function(e){
    if(e.key==='Escape') hideConfigModal();
  });
  </script>
  </div>
  <!-- Removed duplicate Change Password and Logout buttons from login screen -->
    </div>

    <div id="equity_plot" style="margin-top:40px;max-width:700px;"></div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Helper to safely get element by id or simple selector
    const $ = id => {
      if(!id) return null;
      if(typeof id === 'string' && id.startsWith('.')) return document.querySelector(id);
      return document.getElementById(id);
    };

    // Open profit report if button exists
    if($('profit_report_btn')) {
      $('profit_report_btn').onclick = ()=> window.open('/api/profit_report', '_blank');
    }

    // Login form submit handler (only one)
    const loginForm = $('login_form');
    if(loginForm){
      loginForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const email = $('login_email').value.trim();
        const password = $('login_password').value;
        const msg = $('login_msg');
        msg.textContent = '';
        if(!email || !password){ msg.textContent = 'Please enter both email and password.'; return; }
        try{
          const res = await fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password})});
          const data = await res.json();
          if(data.success){
            // mark logged in and show main UI
            localStorage.setItem('bot_logged_in','1');
            try{ localStorage.setItem('bot_user_email', email); }catch(e){}
            // update displayed email immediately
            const lin = $('logged_in_as'); if(lin) lin.textContent = email;
            // Clear login fields after successful login
            if($('login_email')) $('login_email').value = '';
            if($('login_password')) $('login_password').value = '';
            if(typeof restoreUI === 'function') restoreUI();
            if(typeof refresh === 'function') refresh();
          } else {
            msg.textContent = data.message || 'Login failed.';
          }
        }catch(err){ msg.textContent = 'Server error.'; }
      });
    }

    // Utility: show/hide main/login UI (use explicit display values)
    function showMainUI(){ if($('.dashboard-container')) $('.dashboard-container').style.display='flex'; if($('main_card')) $('main_card').style.display='flex'; if($('side_btns')) $('side_btns').style.display='flex'; if($('login_section')) $('login_section').style.display='none'; }
    function showLoginUI(){ if($('.dashboard-container')) $('.dashboard-container').style.display='none'; if($('main_card')) $('main_card').style.display='none'; if($('side_btns')) $('side_btns').style.display='none'; if($('login_section')) $('login_section').style.display='flex'; }

    // restore UI from localStorage (always show dashboard if logged in)
    function restoreUI(){
      if(localStorage.getItem('bot_logged_in')){
        showMainUI();
        const email = localStorage.getItem('bot_user_email'); if(email){ const el = $('logged_in_as'); if(el) el.textContent = email; }
      } else {
        showLoginUI();
      }
    }
    // On page load and after login, always call restoreUI
    restoreUI();

    // Attach logout handler (main and side)
  if($('logout_btn')) $('logout_btn').onclick = ()=>{
    localStorage.removeItem('bot_logged_in');
    try{ localStorage.removeItem('bot_user_email'); }catch(e){};
    if($('logged_in_as')) $('logged_in_as').textContent = '...';
    // Clear login fields after logout
    if($('login_email')) $('login_email').value = '';
    if($('login_password')) $('login_password').value = '';
    showLoginUI();
  };
  if($('logout_btn_side')) $('logout_btn_side').onclick = ()=>{
    localStorage.removeItem('bot_logged_in');
    try{ localStorage.removeItem('bot_user_email'); }catch(e){};
    if($('logged_in_as')) $('logged_in_as').textContent = '...';
    // Clear login fields after logout
    if($('login_email')) $('login_email').value = '';
    if($('login_password')) $('login_password').value = '';
    showLoginUI();
  };

    // Change password handler (main and side)
    if($('change_pw_btn')){
      $('change_pw_btn').onclick = async ()=>{
        const email = prompt('Enter your email:');
        const oldpw = prompt('Enter current password:');
        const newpw = prompt('Enter new password:');
        if(!email||!oldpw||!newpw) return alert('All fields required!');
        try{
          const r = await fetch('/api/change_password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,old_password:oldpw,new_password:newpw})});
          const j = await r.json();
          alert(j.success? 'Password updated' : ('Error: ' + (j.message||'Failed')));
        }catch(e){ alert('Server error'); }
      };
    }
    if($('change_pw_btn_side')){
      $('change_pw_btn_side').onclick = async ()=>{
        const email = prompt('Enter your email:');
        const oldpw = prompt('Enter current password:');
        const newpw = prompt('Enter new password:');
        if(!email||!oldpw||!newpw) return alert('All fields required!');
        try{
          const r = await fetch('/api/change_password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,old_password:oldpw,new_password:newpw})});
          const j = await r.json();
          alert(j.success? 'Password updated' : ('Error: ' + (j.message||'Failed')));
        }catch(e){ alert('Server error'); }
      };
    }

    // Safe attach for equity plot button
    if($('equity_plot_btn')) $('equity_plot_btn').onclick = async ()=>{
      try{ await plotEquityCurve(); }catch(e){}
    };

    // Safe attach for signal/retrain buttons
    if($('signal_btn')) $('signal_btn').onclick = async ()=>{
      if($('terminal')) $('terminal').textContent = 'Running debug_signal.py...';
      const r = await fetch('/api/run_debug_signal'); const j = await r.json(); if($('terminal')) $('terminal').textContent = j.output||'No output.';
    };
    if($('retrain_btn')) $('retrain_btn').onclick = async ()=>{
      if($('terminal')) $('terminal').textContent = 'Running train_model.py...';
      const r = await fetch('/api/run_retrain'); const j = await r.json(); if($('terminal')) $('terminal').textContent = j.output||'No output.';
    };

    // Start / Stop bot handlers
    if($('start')) $('start').onclick = async ()=>{
      const btn = $('start');
      if(btn) { btn.disabled = true; btn.dataset.orig = btn.textContent; btn.textContent = 'Starting...'; }
      if($('terminal')) $('terminal').textContent = 'Starting bot...';
      // read netmode
      let netmode = 'testnet'; const n = document.querySelector('input[name="netmode"]:checked'); if(n) netmode = n.value;
      try{
        const r = await fetch('/api/start',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({netmode})});
        const j = await r.json();
        if($('terminal')) $('terminal').textContent = j.msg || j.message || JSON.stringify(j);
        if(j.ok || j.success) $('status').textContent = 'running';
      }catch(e){ if($('terminal')) $('terminal').textContent = 'Error starting bot'; }
      finally{ if(btn){ btn.disabled = false; btn.textContent = btn.dataset.orig || 'Start Bot'; }}
    };
    if($('stop')) $('stop').onclick = async ()=>{
      const btn = $('stop');
      if(btn) { btn.disabled = true; btn.dataset.orig = btn.textContent; btn.textContent = 'Stopping...'; }
      if($('terminal')) $('terminal').textContent = 'Stopping bot...';
      try{
        const r = await fetch('/api/stop',{method:'POST'}); const j = await r.json();
        if($('terminal')) $('terminal').textContent = j.msg || j.message || JSON.stringify(j);
        if(j.ok || j.success) $('status').textContent = 'stopped';
      }catch(e){ if($('terminal')) $('terminal').textContent = 'Error stopping bot'; }
      finally{ if(btn){ btn.disabled = false; btn.textContent = btn.dataset.orig || 'Stop Bot'; }}
    };

    // refresh() - poll server status and update UI
    async function refresh(){
      try{
        const res = await fetch('/api/status');
        const s = await res.json();
        if(s){
          if($('status')) $('status').textContent = s.running? 'running' : 'stopped';
          if($('bal_usdt')) $('bal_usdt').textContent = s.usdt || '...';
          if($('bal_btc')) $('bal_btc').textContent = s.btc || '...';
          if($('win')) $('win').textContent = s.win!==undefined? s.win : '...';
          if($('loss')) $('loss').textContent = s.loss!==undefined? s.loss : '...';
          if($('pnl')) $('pnl').textContent = s.pnl!==undefined? s.pnl : '...';
          if($('pending')) $('pending').textContent = s.pending!==undefined? s.pending : '...';
          if($('pending_amt')) $('pending_amt').textContent = s.pending_amt!==undefined? s.pending_amt : '...';
          if($('terminal') && s.terminal) $('terminal').textContent = s.terminal;
          // update netmode radio to reflect server
          try{ if(typeof s.use_testnet !== 'undefined'){ const val = s.use_testnet? 'testnet':'mainnet'; const el = document.querySelector('input[name="netmode"][value="'+val+'"]'); if(el) el.checked = true; } }catch(e){}
        }
      }catch(e){ console.warn('refresh failed', e); }
    }
    // initial refresh and interval
    try{ refresh(); setInterval(refresh, 3000); }catch(e){}

    // refresh() and other functions may be defined later in file; guard usage where needed
    // call refresh if available
    try{ if(typeof refresh === 'function') { refresh(); setInterval(()=>{ if(typeof refresh === 'function') refresh(); },3000); } } catch(e){}

    // removed right-column balance sync (right-side small balance block removed)
  </script>
  </body>
</html>
